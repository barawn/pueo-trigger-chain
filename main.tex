\documentclass{article}
\usepackage{graphicx} % Required for inserting images
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{adjustbox}
\usepackage{tikz}
\usetikzlibrary{dsp,chains}
\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}
\newcommand{\z}{\mathpzc{z}}
\newcommand{\chebyu}[2]{U_{#1}\left(#2\right)}
\newcommand{\ssrsample}[2]{#1\left[#2\right]}
\title{First stage trigger system for the Payload for Ultrahigh Energy Observations (PUEO) balloon-borne neutrino detector}
\author{P.S.~Allison}
\date{December 2025}

\begin{document}

\maketitle

\section{Introduction}
\section{Trigger filter chain}

The trigger system for PUEO is fully digital and contains multiple signal 
processing blocks to maximize the detection capability of the instrument,
as shown in Fig.~\ref{triggerfilterchain}. The filter chain consists of
a downsampling block, a matched filter, a CW rejection block, followed by an
upsampling block, and finally an automatic gain control and bit reduction
(AGC-BR) block before entering the digital beamformer. The CW rejection
portion of the filter chain consists of up to 2 programmable digital biquad
filters, with builds with 0, 1, and 2 biquads if needed for power reasons,
selectable during normal operation. Both the upsampling and downsampling
block are based on the same 33-tap finite impulse response halfband filter.

The downsampling, upsampling, and AGC-BR blocks operate at 
$3000\,\text{MSa/s}$ with a supersample rate (SSR) factor of 8 ($M=8$).
The intermediate (matched filter, CW rejection) blocks operate at
$1500\,\text{MSa/s}$ with an SSR factor of 4 ($M=4$), both at a system
clock rate of $375\,\text{MHz}$.

The output of each intermediate block is rounded and constrained to an
overall signed 12-bit range. The final AGC-BR block scales the inputs to
a common scale and reduces the total range to 5 bits (32 total values).

\subsection{Downsample/upsample blocks}

While significant power from the Askaryan signal is observed throughout the
band, the overall SNR peaks in the lower half. This therefore encourages
using a low-pass (halfband) filter to reduce the overall bandwidth to below
$750\,\text{MHz}$, which also allows the remainder of the trigger chain to
decimate by a factor of 2 and operate at $1500\,\text{MSa/s}$ to reduce
power. However, before the AGC-BR block, the signal is restored to
$3000\,\text{MSa/s}$ by zero padding followed by the same halfband filter,
allowing for finer beamforming delays.

The halfband filter is a 31-tap FIR filter operating at a supersample rate
of 8 with an additional 1 sample delay to align the center tap with the
original sample (at $z^{-16}$, two overall system clocks). The transfer
function is:
\[
\resizebox{\hsize}{!}{
H\left(z\right)=K
\left(
\begin{array}{cccccccc}
 & -23z^{-1} &  & +105z^{-3} &  & -263z^{-5} &  & +526z^{-7}\\
 & -949z^{-9} &  & +1672z^{-11} &  & -3216z^{-13} &  & +10342z^{-15}\\
+2^{14}z^{-16} & +10342z^{-17} &  & -3216z^{-19} &  & +1672z^{-21} &  & -949z^{-23}\\
 & +526z^{-25} &  & -263z^{-27} &  & +105z^{-29} &  & -23z^{-31} \\
\end{array}
\right)
}
\]

where $K=2^{-15}$ for the downsample block and $K=2^{-14}$ for the
upsample block, resulting in a net unity gain for the combination of the
two. The symmetric nature of the filter lends itself to being
organized as the sum of two 4-tap systolic filters on individual samples,
with the preadd feature of the FPGA DSP block used to combine the samples
with common coefficients but reversed order, as shown in
Fig.~\ref{fig:halfbandStructure}, represented in supersample rate, where
$x[i]=z^{i}$ and system clocks generate a delay of $z^{-M}$ where
$M=8$.

As an example, ignoring pipeline registers, for one of the filters for
$y[7]$, the first DSP takes in $x[4]$ and preadds $x[2]z^{-3M}$. This
generates the $105\left(z^{-3}+z^{-29}\right)$ for $z^{7}$. The
next DSP receives $x[4]z^{-2M}$ in cascade input and the same $x[2]z^{-3M}$
generating the $1672\left(z^{-11}+z^{-21}\right)z^{-8}$ term for $z^{7}$,
which is added to the delayed output of the first DSP.
This same structure is used for the $x[6]$ and $x[0]$ terms, and the
outputs of those two chains are added together separately. Running the
two separate filters in parallel rather than serially requires an
additional adder, but was shown to reduce power by $\sim0.7\,\text{W}$
for all 8 channels due to the number of registers required to delay
inputs in the serial case.

The additional center tap value ($+2^{14}z^{-16}$) is simply
an upshifted value of the original input, and is added into one of the
systolic filters at the appropriate timepoint.

The same configuration is implemented for each of the 8 samples per
system clock. For the downsample block, since the output is decimated
afterwards, only the even samples are implemented. For the upsample
block, since the decimated odd inputs are zero-stuffed prior, only
the odd samples are implemented and the even samples (which only have
the center tap) are simply delayed to align to the odd samples.

The frequency response of this halfband filter is shown in
Fig.~\ref{fig:halfbandFreqResp}. The limited rejection near Nyquist
results in some aliasing after decimation, but because the aliasing is
equivalent in all channels, the overall beamforming is not affected.

\begin{figure}[h]
\begin{subfigure}{\textwidth}
\includegraphics[width=0.9\textwidth]{plots/halfband_filter_resp.png}
\caption{Frequency response}
\label{fig:halfbandFreqResp}
\end{subfigure}
% FIR filter as block diagram
\begin{subfigure}{\textwidth}
\begin{center}
\input{plots/halfband.tikz}
\end{center}
\caption{Filter structure}
\label{fig:halfbandStructure}
\end{subfigure}
\caption{Halfband filter response and structure, omitting pipeline
registers. Only the structure for sample 7 is shown - the others are
identical except for index rotation and input delays.}
\label{fig:halfbandFilter}
\end{figure}

\subsection{Matched filter block}

The matched filter block mitigates the effect of the antenna and signal
processing chain on the SNR of the input signal. In order to implement a
power and resource-efficient matched filter, a multiplierless filter
was developed by exploiting the fact that the impulse response of the system
has an approximately exponential falloff in voltage. Therefore, the impulse
response was normalized to the peak value, and individual samples were
rounded to $0$, $\pm\frac{1}{4}$, $\pm\frac{1}{2}$, or $\pm1$.
A comparison of the normalized impulse response (post-halfband filter)
and the simplified impulse response in both the time and frequency
domain in shown in Fig.~\ref{fig:matchedimpulse}. The reduced response is
then decimated by a factor of 2 to match the $1500~\text{MSa}/\text{s}$
sample rate in the intermediate part of the processing chain,
time-reversed to create a matched filter, and then scaled by the nearest
power of 2 to a unity gain. The remaining gain variation is unimportant
as it is absorbed in the AGC-BR block.

\begin{figure}[h]
\includegraphics[width=0.9\textwidth]{plots/impulse_resp.png}    
\caption{System impulse response and reduced version generated by
rounding to closest powers of 2 for use in the multiplierless
matched filter.}
\label{fig:matchedimpulse}
\end{figure}

The transfer function of the matched filter at a sample rate of
$1500~\text{MSa}/\text{s}$ is given by

\begin{align*}
H\left(z\right) = \frac{1}{2^{5}} & (-1+z^{-3}-z^{-5}+z^{-7}+z^{-8} \\
                  & -z^{-9}-z^{-10}+z^{-11}+z^{-12}-z^{-13}   \\
                  & -2z^{-14}+2z^{-15}-4z^{-17}+4z^{-18}-2z^{-19}+z^{-20}) \\
\end{align*}

The filter is then simplified by pre-computing $P=\left(1-z^{-1}\right)$
for each sample. The computation of $P$ requires 4 adders at $M=4$, but
reduces the number of terms from $16M$ to $11M$, significantly
reducing the complexity of the filter. The multiplierless nature of the
filter allows it to be implemented efficiently in the FPGA fabric as
sets of ternary adders, which was found to be more power-efficient than a
DSP-based design.

\subsection{CW rejection block}

Up to 2 programmable digital biquad filters were implemented
in the CW rejection block, operating at an SSR factor of 4 $M=4$. 
These sections implemented the transfer function

\[
\label{eq:iirtransfer}
H\left(z\right) = \frac{b_0+b_1z^{-1}+b_0z^{-2}}
{1+P\cos\theta z^{-1}+P^{2}z^{-2}}
\]

which represents a filter with two complementary poles and zeroes.
This structure allows for the creation of two simple notch filters,
or a single higher-order band rejection filter.

\subsubsection{Biquad design}

In a supersample rate design, the poles of a biquad are challenging
because of the inherent feedback. We split up Eq.~\ref{eq:iirtransfer}
into a zero-only section $H_z\left(z\right)=b_0+b_1z^{-1}+b_0z^{-2}$
and a pole-only section 
$H_p\left(z\right)^{-1}=1+P\cos\theta z^{-1}+P^{2}z^{-2}$.

The implementation of $H_p\left(z\right)$ uses pipelining along with
clustered look-ahead and incremental computation \cite{parhiVLSI}.
This is mathematically equivalent to adding compensating poles to the
numerator of the transfer function to increase the order of the
denominator. We use the look-back equation from Feinberg
\cite{feinbergvectorizing} to rewrite $H_p\left(z\right)$ as

\[
\label{eq:clusteredlookback}
H_p\left(z\right)=\frac{\sum_{i=0}^{N-1} \chebyu{i}{\cos\theta}P^{i}z^{-i}}
{1-\chebyu{N}{\cos\theta}P^{N}z^{-N}+\chebyu{N-1}{\cos\theta}P^{N+1}z^{-N-1}}
\]

where $U_{i}\cos\theta$ is the Chebyshev polynomial of the second kind.
Eq.~\ref{eq:clusteredlookback} requires two samples to compute the
updated values, separated by 1 sample. We therefore choose samples 0
and 1, requiring $N=M-1$ for sample 0, and $N=M$ for sample 1. The
implementation for PUEO used $M=4$, however the filter itself was
parameterized for any $M$ and originally tested with $M=8$ in a
$3000\,\text{MSa/s}$ implementation.

We separate off the numerator of \ref{eq:clusteredlookback},
defining

\begin{align*}
    f = & \sum_{i=0}^{M-2}\chebyu{i}{\cos\theta}P^{i}z^{-i}    \\
    g = & \sum_{i=0}^{M-1}\chebyu{i}{\cos\theta}P^{i}z^{-i}
\end{align*}

to obtain a difference equation written in matrix form as

\[
    \begin{pmatrix}
        \ssrsample{y}{0} \\
        \ssrsample{y}{1}
    \end{pmatrix}
    =
    \begin{pmatrix}
        -P^{M}\chebyu{M-2}{\cos\theta} & P^{M-1}\chebyu{M-1}{\cos\theta} \\
        -P^{M+1}\chebyu{M-1}{\cos\theta} & P^{M}\chebyu{M}{\cos\theta}
    \end{pmatrix}
    \begin{pmatrix}
        \ssrsample{y}{0}z^{-M} \\
        \ssrsample{y}{1}z^{-M}
    \end{pmatrix}
    +
    \begin{pmatrix}
        f \\
        g
    \end{pmatrix}
\]

This difference equation is then pipelined by substitution, 
creating a final difference equation of

\[
    \begin{pmatrix}
        \ssrsample{y}{0} \\
        \ssrsample{y}{1}
    \end{pmatrix}
    =
    \begin{pmatrix}
        C_0 & C_1 \\
        C_2 & C_3
    \end{pmatrix}
    \begin{pmatrix}
        \ssrsample{y}{0}z^{-2M} \\
        \ssrsample{y}{1}z^{-2M}
    \end{pmatrix}
    +
    \begin{pmatrix}
        F \\
        G
    \end{pmatrix}
\]

where
\begin{align*}
    \ssrsample{F}{n} = &
        -P^{M}\chebyu{M-2}{\cos\theta}\ssrsample{f}{n-1}+
         P^{M-1}\chebyu{M-1}{\cos\theta}\ssrsample{g}{n-1}+
         \ssrsample{f}{n} \\
    \ssrsample{G}{n} = &
        -P^{M+1}\chebyu{M-1}{\cos\theta}\ssrsample{f}{n-1}+
        P^{M}\chebyu{M}{\cos\theta}\ssrsample{g}{n-1}+
        \ssrsample{g}{n} \\
    C_0 = &
        P^{2M}\left(\left(\chebyu{M-2}{\cos\theta}\right)^{2} -
                   \left(\chebyu{M-1}{\cos\theta}\right)^{2}\right) \\
    C_1 = &
        P^{2M-1}\chebyu{M-1}{\cos\theta}\left(
        \chebyu{M}{\cos\theta}-\chebyu{M-2}{\cos\theta}
        \right) \\
    C_2 = &
        P^{2M+1}\chebyu{M-1}{\cos\theta}\left(
        \chebyu{M-2}{\cos\theta}-\chebyu{M}{\cos\theta}
        \right) \\
    C_3 = &
        P^{2M}\left(\left(\chebyu{M}{\cos\theta}\right)^{2} -
                   \left(\chebyu{M-1}{\cos\theta}\right)^{2}
             \right) 
\end{align*}

The clustered look-ahead implementation here is not guaranteed
to produce a stable filter, however the regions of stability
do include the primary bands where CW interference was previously
seen. When used as a simple notch, the stable frequency/Q phase
space is shown in Fig.~\ref{fig:stablebiquad}. The main limitations
occur outside of $150\,\text{MHz}<f<600\,\text{MHz}$. In previous
balloon flights by the ANITA experiment \ref{tuffpaper}, wide notches
(effective $Q$ of $5-7$) were used at $260$, $375$, and $460\,\text{MHz}$
all of which would be in the stable region for this design.

\subsubsection{Biquad implementation}

$H_{z}\left(z\right)$, $f$, and $g$ are all straightforward FIR filters,
implemented in a cascade with serial coefficient programming.
The $f\left[n-1\right]$ and $g\left[n-1\right]$ terms in the definition
of $F$ and $G$ are calculated in an additional DSP in the cascade with
the prior DSP's output looped to its input. This term is the critical
path in the $F$ and $G$ calculation. Finally, an additional pair of DSPs
calculate the $g$ term in $F$ and the $f$ term in $G$.

The IIR section consists of a cascade of 4 DSPs with pipeline
registers carefully chosen to meet timing, as shown in 
Fig.~\ref{fig:biquaddesign}. Each sample consists of 2 DSPs, with the
output of the second DSP routed back to the input of the first
with a pipeline register after the multiplier. This feedback 
is the critical fabric routing path of the IIR section and
limits this design to a maximum of $\sim425\,\text{MHz}$ with
the given device. The second DSP takes in the other sample's output
with the pipeline register at the input to the DSP.

Lastly, the incremental computation section consists of $2M-4$
DSPs arranged in a cascade to both allow serial coefficient
programming and input sharing between adjacent samples.

An example of the frequency response of the CW rejection section
programmed as a 4th order bandstop is shown in Fig.~\ref{fig:biquaddesign}.
The DSP resource usage for the biquad breaks down as

\begin{itemize}
    \item $H_{z}$ -- $2M$
    \item $F$ and $G$ -- $2M+3$
    \item IIR and incremental computation -- $2M$
\end{itemize}

or $6M+3$ total DSPs. 

\begin{figure}
    \begin{center}
    \input{plots/iir.tikz}
    \end{center}
    \caption{Structure of the IIR section of the programmable
    biquad. Pipeline registers were carefully chosen to allow
    the design to meet timing. The critical paths are through
    the $C_{0}$/$C_{3}$ multiplier.}
    \label{fig:biquaddesign}
\end{figure}

The CW rejection section can also be placed into a bypass mode
where the overall transfer function is switched to $H\left(z\right)=1$
by swapping the $b_{1}$ coefficient to 1 and forcing the multiplier
outputs in the DSPs sequentially into reset. The overall trigger
is blocked during these transition periods to prevent glitching
issues. These transitions can be commanded globally to allow the
notches to only apply to specific channels as needed, however this
functionality was not used due to time pressure with the
flight software.

During the PUEO flight, parameter values for a range of
second-order notches and the 4th order bandstop were pre-computed
into the flight software.

\section{Automatic gain control and bit reduction (AGC-BR) block}

The last block before the beamforming section is the AGC-BR block,
which normalizes each of the channels based on thermal noise
statistics and reduces the overall dynamic range to a symmetric
signed 5-bit representation - that is, values are represented as
a two's complement $x^{\prime}=x-0.5$, and the constant offsets
are tracked and corrected for. The scaling of the AGC-BR block
targets an output RMS of $4$, meaning $1\,\text{LSB}=0.25\sigma$
with zero mean. The symmetric 5-bit representation means that the
output now represents values between $\pm3.875\sigma$. Values outside
this range are clipped to the maximum/minimum values.

In addition to the signed outputs, the AGC-BR block also generates
the absolute value and $x>2\sigma$ and $x<2\sigma$ (tail fraction)
indicators. Because of the symmetric representation, both of these
outputs are trivial, as
$\text{abs}\left(x\left[4:0\right]\right)=x\left[4\right]\oplus x\left[3:0\right]$,
$x<2\sigma =x\left[4\right]\cdot \overline{x\left[3\right]}$ and
$x>2\sigma = \overline{x\left[4\right]} \cdot x\left[3\right]$.

The 4-bit absolute value is mapped to its true square and
accumulated using a custom-logic adder and the tail fraction
indicators increment counters over a full AGC-BR measurement period.
Once the measurement period is complete, a per-channel control loop
increments or decrements the scaling factor if the square is outside of a
target range, and increments or decrements an offset based on the
difference of the tail fraction counters. The simple control loop
does result in a slight remaining variation of $\sim1\%$ which is
sufficient given the overall variation in the analog signal path.

\section{Beamforming and trigger}

\subsection{Beamforming and coherent sum}

\subsection{Square and envelope formation}

Once the individual 8-bit samples for each beam are formed,
a simple envelope is generated by squaring each sample
and computing an 8-sample sum every 4 samples.

The squarer was based on the signed 8-bit logic given by 
Wires et al. \cite{wiresoptsquare}, but optimized for the
fabric of the UltraScale family and their generic 5-input,
2-output lookup table (LUT).

The squarer adder tree was structured overall as a ternary adder,
with a 3:2 compressor embedded into the LUT, with one (sum) output
feeding into the carry chain and the second (carry) output
routed to the next bit. Additionally, two 4-bit secondary terms
were computed from the sum of several partial products containing
only 5 common inputs, which allowed them to be directly computed
without a carry chain.

Several bits in the ternary adder were left with unused outputs,
allowing other secondary terms to be generated,
reducing the total size to a 10-bit ternary adder (10 LUTs) and
4 additional auxiliary LUTs, fitting in less than 2 UltraScale
slices. For comparison, a synthesis-generated 8-bit square generated over
8 slices of logic, a logic reduction of over a factor of 4. The worst
critical path of the logic consists of 4 levels of logic
(3 LUT propagation times plus the carry chain), corresponding to
$\sim0.75\,\text{ns}$ in the device used, significantly less than
the synthesis-generated design.

\begin{figure}
$\begin{array}{cccccccccc}
s_{14} & s_{13} & s_{12} & s_{11} & s_{10} & s_{9} & s_{8} & s_{7} & s_{6} & s_{5}\\
\hline 
T_{14} & T_{13} & \overline{a_{7}a_{4}} & T_{11} & \overline{P_{72}} & \overline{a_{7}a_{1}} & \overline{a_{7}a_{0}} & a_{6}a_{0} & a_{5}a_{0} & T_{5} \\
 &  & c_{3} &  & c_{1} & c_{0} & a_{6}a_{1} & d_{1} & d_{0} & P_{40}\\
 &  & \overline{a_{7}a_{3}}c_{2} &  & \bar{d}_{3}a_{4} & d_{3} & d_{2}
\end{array}$


\[
\begin{array}{cccc}
c_{3} & c_{2} & c_{1} & c_{0}\\
\hline a_{6}\bar{a}_{5} & a_{6}a_{4} & a_{6}a_{3} & a_{6}a_{2}\\
 & a_{5}a_{4} & a_{5}\bar{a}_{4} & a_{5}a_{3}\\
 &  &  & a_{5}a_{2}\left(a_{3}\lor\bar{a}_{4}\right)
\end{array}
\]

\[
\begin{array}{cccc}
d_{3} & d_{2} & d_{1} & d_{0}\\
\hline a_{4} & a_{5}a_{2}\oplus\overline{a_{4}\bar{a}_{3}} & a_{5}a_{1} & a_{3}\bar{a}_{2}\\
 &  & a_{4}a_{2} & a_{4}a_{1}\\
 &  & a_{3}a_{2} & a_{3}a_{2}a_{1}
\end{array}
\]

\begin{align*}
T_{5} = & a_{3}a_{1}\oplus a_{3}a_{2}a_{0}\oplus a_{2}a_{1} \,(\text{internal logic to bit 5})  \\
T_{11} = & \overline{a_{7}a_{3}}\oplus c_{2}\,(\text{internal logic to bit 11}) \\
T_{13} = & \overline{a_{7}a_{5}}\oplus a_{6}a_{5}\,(\text{internal logic to bit 13}) \\
T_{14} = & \overline{a_{7}\bar{a}_{6}}\oplus\bar{a}_{7}a_{6}a_{5}\,(\text{internal logic to bit 14}) \\
P_{40} = & a_{4}a_{0}\,(\text{secondary output from bit 7}) \\
P_{72} = & a_{7}a_{2}\,(\text{secondary output from bit 11}) \\
b_{4} = & a_{2}\overline{a_{1}} \oplus a_{3}a_{0} \oplus a_{2}a_{1}a_{0}\,
(\text{secondary output from bit 5}) \\
b_{3} = & a_{2}a_{1} \oplus a_{1}a_{0}\,(\text{secondary output from bit 6}) \\
b_{2} = & a_{1}\overline{a_{0}}\,(\text{secondary output from bit 14}) \\
b_{1} = & 0 \\
b_{0} = & a_{0} \\
\end{align*}

\caption{Optimized two's complement 8-bit square logic for 5-bit
input, 2-bit output LUTs. The overall logic consists of a 10-bit ternary
adder structure and several pre-computed partial products and
secondary terms. The two 4-bit secondary terms are logically outputs
of ternary adders, but since the terms are all derived from only 5 inputs
these are implemented as direct LUTs. The squarer fits into 2
UltraScale slices, a total of 4 LUTs and a 10-bit adder structure.}
\end{figure}

After the square of each sample was generated, the final step
in the envelope trigger was to compute an 8-sample sum every 4 samples,
which corresponds to 2 samples every system clock. Because the sums
are thresholded, only the larger of the two matters: therefore,
we compute the sum of samples 4 to 7,  compare to the previous
clock cycle, and retain only the larger of the two. This max sum
is then added to the sum of samples 0 to 3, generating the max of
$\sum_{i=4}^{7}x\left[i\right]z^{-8}+\sum_{i=0}^{3}x\left[i\right]$
and $\sum_{i=0}^{7}x\left[i\right]$. This value is then thresholded
twice - one threshold is used to generate the trigger output of
that beam, and the second threshold is used as a subtrigger
monitoring threshold to allow monitoring the beam behavior with
higher statistics.

\section{Resource usage and performance}

The overall major resource usage breakdown for the trigger system
is shown in Table~\ref{tab:resource}. In total, with 2 biquads,
the trigger system uses $\sim12\%$ of the CLBs in the
device and $\sim26\%$ of the DSPs.

\begin{table}
\begin{center}
\begin{tabular}{ |c|c|c| } 
 \hline
    & Slices & DSPs \\
    \hline
    Total available on device & 53160 & 4272  \\
    Signal processing chain (excluding biquads) & 2767 & 584  \\
    Biquad (each, up to 2) & 800 & 200  \\
    Beamforming trigger (48 total beams) & 2120 & 120  \\
 \hline
\end{tabular}
\end{center}
\caption{
\label{tab:resource} Resource usage for the trigger chain.
Each slice consists of 8 LUTs and 16 registers. The beamforming
trigger section also consists of resources to monitor the trigger
rates of each beam for threshold monitoring.
}
\end{table}


\end{document}
